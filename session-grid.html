<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="/css/session-grid.css">
  </head>
  <body>
    <div class="movies">
      <div class="movie" data-movie-id="o1">
        <img class="movie-poster" src="/posters/intestell.jpg" alt="poster">
        <h3 class="movie-title">
          Звёздные войны XXIII
        </h3>
        <p class="movie-duration">
          130 минут
        </p>
      </div>

      <div class="movie" data-movie-id="o2">
        <img class="movie-poster" src="/posters/Synok.jpg" alt="poster">
        <h3 class="movie-title">
          Миссия выполнима
        </h3>
        <p class="movie-duration">
          120 минут
        </p>
      </div>

      <div class="movie" data-movie-id="o3">
        <img class="movie-poster" src="/posters/mIY2Q7ed00Y.jpg" alt="poster">
        <h3 class="movie-title">
          Серая пантера
        </h3>
        <p class="movie-duration">
          90 минут
        </p>
      </div>
    </div>

    <div class="seances">
      <div class="seances-hall" data-id="o1">
        <h3 class="seances-title">Зал 1</h3>
        <div class="seances-timeline">

        </div>
      </div>

      <div class="seances-hall" data-id="o2">
        <h3 class="seances-title">Зал 2</h3>
        <div class="seances-timeline">

        </div>
      </div>

    </div>
    <div class="popup">
      <div class="popup-content">
        <form class="" action="" method="post" name="add_movie">
          <label for="name">Фильм</label>
          <input type="text" name="name" value=""><br/>
          <input type="hidden" name="movie_id" value=""><br/>
          <label for="start_time">Время</label>
          <input type="time" name="start_time" value=""><br/>
          <label for="hall">Зал</label>
          <select name="hall" id="select_hall">
            <option disabled selected value="o">Выбор зала</option>
            <option value="o0"></option>
          </select>
          <br/>
          <!-- <input type="text" name="hall" value=""><br/> -->
          <input type="hidden" name="movie_id">
          <input type="submit" name="submit" value="Добавить">
        </form>
      </div>
    </div>

    <script type="text/javascript">
      let currentDroppable = null;
      //Коллекция HTML-элементов с классом movie
      const movies = document.querySelector('.movies');
      movies.addEventListener('mousedown', (event) => {
        let target = event.target;
        if (target.classList.contains('movie') || target.closest('.movie')) {
          let movieData = new Movie(target.closest('.movie'));
          let movieDragg = target.closest('.movie').cloneNode(true);
          movieDragg.style.position = 'absolute';
          movieDragg.style.zIndex = 1000;
          document.body.append(movieDragg);

          moveAt(event.pageX, event.pageY);

          document.addEventListener('mousemove', onMouseMove);

          movieDragg.addEventListener('mouseup', (event) => {
            event.preventDefault();
            console.log(event);
            document.removeEventListener('mousemove', onMouseMove);
            movieDragg.remove();
            movieDragg.onmouseup = null;
          });

          function moveAt(pageX, pageY) {
            //// Позиционирование копии элемента со сдвигом относительно указателя мыши
            movieDragg.style.left = pageX - (movieDragg.getBoundingClientRect().right - movieDragg.getBoundingClientRect().left) / 2 + 'px';
            movieDragg.style.top = pageY - (movieDragg.getBoundingClientRect().bottom - movieDragg.getBoundingClientRect().top) / 2 + 'px';
          }

          function onMouseMove(event) {
            moveAt(event.pageX, event.pageY);
            // внутри обработчика события мыши прячем переносимый элемент
            movieDragg.style.display = 'none';
            // elemBelow - возможная цель переноса
            let elemBelow = document.elementFromPoint(event.clientX, event.clientY);
            movieDragg.style.display = 'block';

            // событие mousemove может произойти и когда указатель за пределами окна
            // (элемент перетащили за пределы экрана)
            // если clientX/clientY за пределами окна, elementFromPoint вернёт null
            if (!elemBelow) {
              console.log('Attention!');
              return;
            }
            // потенциальные цели переноса помечены классом 'seances' (может быть и другая логика)
            let droppableBelow = elemBelow.closest('.seances');

            if (currentDroppable != droppableBelow) {
              // мы либо залетаем на цель, либо улетаем из неё
              // внимание: оба значения могут быть null
              // currentDroppable=null,
              // если мы были не над droppable/seances до этого события (например, над пустым пространством)
              // droppableBelow=null,
              // если мы не над droppable/seances именно сейчас, во время этого события

              currentDroppable = droppableBelow;

              if (currentDroppable) {
                enterDroppable(currentDroppable);
                document.removeEventListener('mousemove', onMouseMove);

                movieDragg.remove();
                console.log('Gool!');
              }

            }

          }

          function enterDroppable(elem) {
            document.forms.add_movie.elements.name.value = movieData.name;
            document.forms.add_movie.elements.movie_id.value = movieData.movieId;
            document.querySelector('.popup').classList.add('active');
          }
        }
          //Отключение обработчиков браузера
          target.ondragstart = function() {
            return false;
          };
      });

      const addMovie = document.forms.add_movie;
      const hallsList = document.getElementsByClassName('seances-hall');
      const selectHall = document.querySelector('#select_hall');
      selectHall.innerHTML = '';
      for (let hall of hallsList) {
        selectHall.innerHTML += `<option value="${hall.dataset.id}">${hall.innerText}</option>`;
      }
      console.log(hallsList);
      const dataSession = {};
      addMovie.addEventListener('submit', () => {
        event.preventDefault();
        const formData = new FormData(addMovie);
        const entries = formData.entries();
        for (let item of entries) {
          dataSession[`${item[0]}`] = `${item[1]}`;
        }
        console.log(dataSession);
        for (let hall of hallsList) {
          if (hall.dataset.id === dataSession['hall']) {
            const sessionMovie = document.createElement('div');
            sessionMovie.dataset.movieId = dataSession['movie_id'];
            sessionMovie.innerText = dataSession['name'];
            hall.querySelector('.seances-timeline').insertAdjacentElement('afterBegin', sessionMovie);
          }
        }
        document.querySelector('.popup').classList.remove('active');
        console.log(formData.get('name') + ', ' + formData.get('movie_id') );
      });




      class Movie {
        constructor(element) {
          if (!element) {
            throw new Error('Элемент не существует');
          }
          this.element = element;
          this.name = this.getName();
          this.duration = this.getDuration();
          this.movieId = this.getMovieId();
        }
        getName() {
          return this.element.querySelector('.movie-title').innerText;
        }
        getDuration() {
          return this.element.querySelector('.movie-duration').innerText;
        }
        getMovieId() {
          return this.element.dataset.movieId;
        }
      }
    </script>
  </body>
</html>
