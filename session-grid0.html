<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="/css/session-grid.css">
  </head>
  <body>
    <div class="movies">
      <div class="movie" data-movie-id="o1">
        <img class="movie-poster" src="/posters/intestell.jpg" alt="poster">
        <h3 class="movie-title">
          Звёздные войны XXIII
        </h3>
        <p class="movie-duration">
          130 минут
        </p>
      </div>

      <div class="movie" data-movie-id="o2">
        <img class="movie-poster" src="/posters/Synok.jpg" alt="poster">
        <h3 class="movie-title">
          Миссия выполнима
        </h3>
        <p class="movie-duration">
          120 минут
        </p>
      </div>

      <div class="movie" data-movie-id="o3">
        <img class="movie-poster" src="/posters/mIY2Q7ed00Y.jpg" alt="poster">
        <h3 class="movie-title">
          Серая пантера
        </h3>
        <p class="movie-duration">
          90 минут
        </p>
      </div>
    </div>

    <div class="seances">
      <div class="seances-hall">
        <h3 class="seances-title">Зал 1</h3>
        <div class="seances-timeline">

        </div>
      </div>

      <div class="seances-hall">
        <h3 class="seances-title">Зал 2</h3>
        <div class="seances-timeline">

        </div>
      </div>

    </div>
    <div class="popup">
      <div class="popup-content">
        <form class="" action="" method="post" name="add_movie">
          <label for="name">Фильм</label>
          <input type="text" name="name" value=""><br/>
          <label for="start_time">Время</label>
          <input type="time" name="start_time" value=""><br/>
          <label for="hall">Зал</label>
          <input type="text" name="hall" value=""><br/>
          <input type="submit" name="submit" value="Добавить">
        </form>
      </div>
    </div>

    <script type="text/javascript">
      let currentDroppable = null;
      //Коллекция HTML-элементов с классом movie
      let movies = document.getElementsByClassName('movie');
      // Назначение обработчика нажатия на левую клавишу мыши
      // для каждого элемента из коллекции
      for (let movie of movies) {
        movie.addEventListener('mousedown', (event) => {
          console.log(event);
          //Создание копии элемента над которым произошло нажатие кнопки
          const movieDragg = movie.cloneNode(true);

          // movieDragg.style.marginLeft = 0;
          // movieDragg.style.marginRight = 0;

          // расстояние по оси X от курсора до левого края элемента


          // let shiftX = window.pageXOffset;
          // let shiftX = (movieDragg.getBoundingClientRect().right - movieDragg.getBoundingClientRect().left) / 2 + window.pageXOffset;
          // let shiftX = event.clientX - movieDragg.getBoundingClientRect().left;

          // расстояние по оси Y от курсора до верхнего края элемента
          // let shiftY = window.pageYOffset ;
          // let shiftY = (movieDragg.getBoundingClientRect().bottom - movieDragg.getBoundingClientRect().top) / 2 + window.pageYOffset ;
          // let shiftY = event.clientY - movieDragg.getBoundingClientRect().top;

          // назначение абсолютного положения копии элемента в html-структуре
          movieDragg.style.position = 'absolute';
          // Вынос копии элемента на самый верх
          movieDragg.style.zIndex = 1000;
          // Добавление копии элемента в HTML-структуру страницы
          document.body.append(movieDragg);
          // console.log(movieDragg.getBoundingClientRect().right + ', ' +
          // movieDragg.getBoundingClientRect().left + ', ' +
          // window.pageXOffset);

          // console.log(movieDragg.getBoundingClientRect().bottom + ', ' +
          // movieDragg.getBoundingClientRect().top + ', ' +
          // window.pageYOffset);
          // Сдвиг копии элемента
          moveAt(event.pageX, event.pageY);
          // moveAt(event.pageX, event.pageY);

          // передвигаем копию элемента при событии mousemove
          document.addEventListener('mousemove', onMouseMove);

          // отпустить копию элемента, удалить ненужные обработчики
          movieDragg.onmouseup = function() {
            document.removeEventListener('mousemove', onMouseMove);
            // return undefined;
            movieDragg.onmouseup = null;
            // movieDragg.remove();
          };

          // Функция переноса на координаты (pageX, pageY),
          // дополнительно учитывая изначальный сдвиг относительно указателя мыши
          function moveAt(pageX, pageY) {
            // movieDragg.style.left = pageX - 0 + 'px';
            // movieDragg.style.top = pageY - 0 + 'px';
            //// Позиционирование копии элемента со сдвигом относительно указателя мыши
            // movieDragg.style.left = pageX  - movieDragg.offsetWidth / 2 + 'px';
            // movieDragg.style.top = pageY - movieDragg.offsetHeight / 2 + 'px';
            // movieDragg.style.left = window.pageXOffset + 'px';
            // movieDragg.style.top = window.pageYOffset + 'px';

            movieDragg.style.left = pageX - (movieDragg.getBoundingClientRect().right - movieDragg.getBoundingClientRect().left) / 2 + 'px';


            movieDragg.style.top = pageY - (movieDragg.getBoundingClientRect().bottom - movieDragg.getBoundingClientRect().top) / 2 + 'px';

            // movieDragg.style.left = pageX - window.pageXOffset - (movieDragg.getBoundingClientRect().right - movieDragg.getBoundingClientRect().left) / 2 + 'px';
            //
            //
            // movieDragg.style.top = pageY - window.pageYOffset - (movieDragg.getBoundingClientRect().bottom - movieDragg.getBoundingClientRect().top) / 2 + 'px';

            // console.log(movieDragg.style.left + ', ' + movieDragg.style.top);
            // movieDragg.style.left = pageX - shiftX + 'px';
            // movieDragg.style.top = pageY - shiftY + 'px';
          }

          function onMouseMove(event) {
            moveAt(event.pageX, event.pageY);
            // внутри обработчика события мыши
            // прячем переносимый элемент
            movieDragg.style.display = 'none';
            // movieDragg.hidden = true;
            // elemBelow - возможная цель переноса
            let elemBelow = document.elementFromPoint(event.clientX, event.clientY);
            movieDragg.style.display = 'block';
            // movieDragg.hidden = false;

            // событие mousemove может произойти и когда указатель за пределами окна
            // (элемент перетащили за пределы экрана)
            // если clientX/clientY за пределами окна, elementFromPoint вернёт null
            if (!elemBelow) {
              console.log('Attention!');
              return;
            }
            // потенциальные цели переноса помечены классом 'seances' (может быть и другая логика)
            // let droppableBelow = elemBelow.querySelector('.seances-hall');
            let droppableBelow = elemBelow.closest('.seances');

            if (currentDroppable != droppableBelow) {
              // мы либо залетаем на цель, либо улетаем из неё
              // внимание: оба значения могут быть null
              // currentDroppable=null,
              // если мы были не над droppable/seances до этого события (например, над пустым пространством)
              // droppableBelow=null,
              // если мы не над droppable/seances именно сейчас, во время этого события
              if (currentDroppable) {
                leaveDroppable(currentDroppable);
              }

              currentDroppable = droppableBelow;

              if (currentDroppable) {
                enterDroppable(currentDroppable);
                movieDragg.remove();
                console.log('Gool!');
                // document.querySelector('.border-gate').innerText = data.ball_title;
              }
            }
          }
        });

        function enterDroppable(elem) {
          elem.style.backgroundColor = 'red';
          document.querySelector('.popup').classList.add('active');
        }

        function leaveDroppable(elem) {
          elem.style.backgroundColor = '';
        }
        //Отключение обработчиков браузера
        movie.ondragstart = function() {
          return false;
        };
      }
      // movies.addEventListener('mousedown', (event) => {
      //   console.log(event);
      // });
      // let currentDroppable = null;
      // const movies = document.querySelector('.movies');
      // console.log(movies);
      // movies.addEventListener('mousedown', (event) => {
      //   console.log(event);
      //   let target = event.target;
      //   if (target.classList.contains('movie')) {
      //     // let movieDragg = new Movie(target);
      //     // console.log(movieDragg.name + ' - ' + movieDragg.duration + ', ' + movieDragg.movieId);
      //     const draggMovie = target.cloneNode();
      //     console.log(target.clientX + ' ' + target.clientY);
      //     let shiftX = target.clientX - draggMovie.getBoundingClientRect().left;
      //     let shiftY = target.clientY - draggMovie.getBoundingClientRect().top;
      //     draggMovie.style.position = 'absolute';
      //     draggMovie.style.zIndex = 1000;
      //     document.body.append(draggMovie);
      //
      //     moveAt(event.pageX, event.pageY);
      //
      //     document.addEventListener('mousemove', onMouseMove);
      //
      //     draggMovie.onmouseup = function() {
      //       document.removeEventListener('mousemove', onMouseMove);
      //       draggMovie.onmouseup = null;
      //     };
      //
      //     function moveAt(pageX, pageY) {
      //       draggMovie.style.left = pageX - shiftX + 'px';
      //       draggMovie.style.top = pageY - shiftY + 'px';
      //     }
      //
      //     function onMouseMove(target) {
      //       moveAt(event.pageX, event.pageY);
      //       draggMovie.hidden = true;
      //       let elemBelow = document.elementFromPoint(event.clientX, event.clientY);
      //       draggMovie.hidden = false;
      //
      //       if (!elemBelow) return;
      //
      //       let droppableBelow = elemBelow.closest('.seances');
      //
      //       if (currentDroppable != droppableBelow) {
      //         if (currentDroppable) {
      //           leaveDroppable(currentDroppable);
      //         }
      //
      //         currentDroppable = droppableBelow;
      //
      //         if (currentDroppable) {
      //           enterDroppable(currentDroppable);
      //           draggMovie.remove();
      //           // console.log('Gool!');
      //           // document.querySelector('.border-gate').innerText = data.ball_title;
      //         }
      //
      //       }
      //
      //     }
      //   }
      //
      // });
      //
      // function enterDroppable(elem) {
      //   elem.style.background = 'red';
      // }
      //
      // function leaveDroppable(elem) {
      //   elem.style.background = '';
      // }
      //
      // movies.ondragstart = function() {
      //   return false;
      // };


      class Movie {
        constructor(element) {
          if (!element) {
            throw new Error('Элемент не существует');
          }
          this.element = element;
          this.name = this.getName();
          this.duration = this.getDuration();
          this.movieId = this.getMovieId();
        }
        getName() {
          return this.element.querySelector('.movie-title').innerText;
        }
        getDuration() {
          return this.element.querySelector('.movie-duration').innerText;
        }
        getMovieId() {
          return this.element.dataset.movieId;
        }
      }
    </script>
  </body>
</html>
